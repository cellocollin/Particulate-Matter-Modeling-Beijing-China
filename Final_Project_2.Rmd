---
title: "Final Project: Regression From The Mean"
author: "Zhengtao Xu, Jennings Cheng and Collin Carmichael"
date: "8/6/2021"

output:
  pdf_document: 
    latex_engine: xelatex
    keep_tex: yes
  html_document: default
---


**Section 1: Introduction**

**Section 2: Exploratory Data Analysis**


```{r include=FALSE}
library(lars)
library(sm)
library(leaps)
library(stats)
library(pls)
library("tidyverse")
library("lubridate")
library("ggplot2")
library(ggcorrplot)
library(corrplot)
library(dplyr)
library(ggpubr)
library(plyr)
library(faraway)
library(lmtest)
library(nlme)
library(MASS)

```


```{r include=FALSE}
#Read and check data
Pollution<-read.csv("Final Project Data.csv",header=TRUE)
Pollution
head(Pollution)
names(Pollution)
summary(Pollution)
# Change TEMP and PRES as numeric
Pollution$TEMP<-as.numeric(Pollution$TEMP)
Pollution$PRES<-as.numeric(Pollution$PRES)
summary(Pollution)
#Create date-time column for hourly data
Pollution$Date_H=with(Pollution, ymd_h(paste(Year, Month, Day, Hour, sep= ' ')))
Pollution
#Create date column for daily data
Pollution$Date_D=with(Pollution, ymd(paste(Year, Month, Day)))
Pollution[1:5,]
#Hourly Plots
Pollution %>% 
  ggplot(aes(Date_H,PM2.5))+ geom_line()
# Build Daily data
Pollution
Pollution_Daily<-Pollution %>%
  group_by(Date_D) %>%
  summarise(
  Avg_Day_PM2.5=mean(PM2.5,na.rm=TRUE),
  Avg_Day_DEWP=mean(DEWP,na.rm=TRUE),
  Avg_Day_TEMP=mean(TEMP,na.rm=TRUE),
  Avg_Day_PRES=mean(PRES,na.rm=TRUE),
  Max_Day_LWS=max(LWS,na.rm=TRUE),
  Max_Day_LS=max(LS,na.rm=TRUE),
  Max_Day_LR=max(LR,na.rm=TRUE),
  Max_Day_CBWD=nth(CBWD,which.max(LWS)))
Pollution_Daily
# Convert Daily table to a data frame
Pollution_Daily=as.data.frame(Pollution_Daily)
# Check data structure and data summary
str(Pollution_Daily)
summary(Pollution_Daily)
# Daily Plots


#Use functions year, month and day to create Year, Month and Day Columns
#Pollution_Daily$Year=year(Pollution_Daily$Date_D)
#Pollution_Daily$Month=month(Pollution_Daily$Date_D)
#Pollution_Daily$Day=day(Pollution_Daily$Date_D)
#head(Pollution_Daily)
#Fix NaN values in PM2.5 and set to NAs
#Pollution_Daily$Avg_Day_PM2.5[is.nan(Pollution_Daily$Avg_Day_PM2.5)]<-NA
#Pollution_Daily
#Train test


Pollution_Daily<-read.table('Pollution_Daily.csv',header=TRUE)
Pollution_Daily <- as.data.frame(Pollution_Daily)
Pollution_Daily$Year=year(Pollution_Daily$Date_D)
Pollution_Daily$Month=month(Pollution_Daily$Date_D)
Pollution_Daily$Day=day(Pollution_Daily$Date_D)
Pollution_Daily$Avg_Day_PM2.5[is.nan(Pollution_Daily$Avg_Day_PM2.5)]<-NA
Pollution_Daily
Pollution_Daily.test=Pollution_Daily[seq(1,nrow(Pollution_Daily),5), ]
Pollution_Daily.train = Pollution_Daily[-seq(1, nrow(Pollution_Daily) , 5 ) , ]

```
```{r echo=FALSE}
Pollution_Daily_nona<-na.omit(Pollution_Daily)
  #Pollution_Daily_nona
keeps<-c("Avg_Day_PM2.5",'Avg_Day_DEWP','Avg_Day_TEMP','Avg_Day_PRES','Max_Day_LWS' , 'Avg_Day_PRES' 
         , 'Max_Day_LWS' , 'Max_Day_LS' , 'Max_Day_LR')
num_cols <- unlist(lapply(Pollution_Daily_nona, is.numeric))
nump=Pollution_Daily_nona [ , num_cols ]

ggcorrplot(cor(nump))


```
Looking at a correlation heatmap we see aside from dewpoint precipitation and temperature there are no significant correlation in other variable

```{r echo=FALSE}
#Summary stat
#summary(Pollution_Daily)
#9 graph that show distribution of number column
par(mfrow=c(3,3))
hist(Pollution_Daily$Avg_Day_PM2.5)

hist(Pollution_Daily$Avg_Day_DEWP)
hist(Pollution_Daily$Avg_Day_TEMP)
hist(Pollution_Daily$Avg_Day_PRES)
hist(Pollution_Daily$Max_Day_LWS)
hist(Pollution_Daily$Max_Day_LS)
hist(Pollution_Daily$Max_Day_LR)
barplot(prop.table(table(Pollution_Daily$Max_Day_CBWD)))
qqnorm(Pollution_Daily$Avg_Day_PRES)
qqline(Pollution_Daily$Avg_Day_PRES)
```
We can see that PM2.5 has an inverse distribution with values skewed towards low PM2.5 but many high values that go beyond the median

Temp and Dew point are highly related and so may not need to be included in the same model

Precipitation looks like a bell curve but not normal as seen in the plot in 3,3

Wind speed is similar but not identical to PM2.5 in that it has an inverse distribution so it may be highly important in prediction

There is almost always not any snow in Beijing and the max is 27 for a day

Rain is also infrequent but there are times when there is a lot of rain so we may assume that rain and snow are not the same

The most common direction is SE and NW while sometimes NE or CV

Now that we know the distributions we can take a look at some pm2.5 vs predictor

```{r echo = FALSE , out.width="90%" , out.height = "75%"}
#par(mfrow=c(3,3))
#Pollution_Daily

#tempdew <- lm(Pollution_Daily$Avg_Day_DEWP  ~ Pollution_Daily$Avg_Day_TEMP)
#temppres <- lm(Pollution_Daily$Avg_Day_PRES ~ Pollution_Daily$Avg_Day_TEMP)
plot(1:1826,Pollution_Daily$Avg_Day_PM2.5,type='l',xlab='day')

```

we can see pm2.5 against time is not a clear relationship and there are many seasonal spikes - One thing is that since there are random fluctations in our final model we will not use date since in a regression model the advance of one day would theoretically advance pm2.5 which is not the relationship we see

We can also extract that dew, temp, pres are very clearly related from the following:

```{r echo=FALSE , out.width= "90%" , out.height="90%"}
par(mfrow=c(2,2))
plot(1:1826,Pollution_Daily$Avg_Day_TEMP,type="l",xlab="day",ylab='temp')
plot(1:1826,Pollution_Daily$Avg_Day_DEWP,type='l',xlab='day',ylab='dew')
plot(1:1826,Pollution_Daily$Avg_Day_PRES,type='l',xlab='day',ylab='pres')
plot(Pollution_Daily$Max_Day_LWS , Pollution_Daily$Avg_Day_PM2.5,xlab='max wind' , ylab='2.5')
```
Dew and temp are very similar and pres is the opposite so we may not necessarily need all three in the final model 

Max wind is also related to Avg_Day_PM2.5 since more wind produces less 2.5



At first glance it may seem that pm2.5 may not vary with month day or year since there are a lot of random spike but looking at a mean of all pm2.5 with each factor shows us that it indeed is influenced highly by these predictor

```{r echo=FALSE}
pmday=ggplot(Pollution_Daily,aes(Day,Avg_Day_PM2.5))+
geom_line() 
myvar <- c('Avg_Day_PM2.5','Day','Year','Month')

daypm <- Pollution_Daily[myvar]
pollutionnona <- na.omit(daypm)

day2.5=1:31
year2.5=1:4
month2.5=1:12
for (k in 1:5)
{
  year2.5[k] <- mean(pollutionnona$Avg_Day_PM2.5[pollutionnona$Year == k+2009])
}
for (k in 1:31){
day2.5[k] <- mean(pollutionnona$Avg_Day_PM2.5[pollutionnona$Day == k])}
for (k in 1:12)
{
  month2.5[k] <- mean(pollutionnona$Avg_Day_PM2.5[pollutionnona$Month == k])
}
par(mfrow=c(3,1))
plot(1:12 , month2.5 , type = "h" , xlab="month" , ylab='pm2.5 avg '
         )
plot(2010 : 2014, year2.5, type='h' , xlab='year' , ylab='pm2.5 avg')
plot(1:31 , day2.5, type='h' , xlab='day' , ylab= ' pm2.5 avg')
```
As we see the variation between the month year and day is important and vary so therefore for the sake of fitting a model between these years every variable will be important beside Date_D

**3.1: Fitting model and diagnostic**
```{r , echo = FALSE }
##Fitting Full Model
trainingdate <- Pollution_Daily.train [ , - 1 ]
lm_all=lm(Avg_Day_PM2.5~.,data=trainingdate)
row.names(Pollution_Daily.test) <- NULL

testpm=predict.lm(lm_all , Pollution_Daily.test [ , -1 ] )

#visually test
summary(lm_all)
plot(c(1:366) ,  testpm , type = "l" , lwd= "2" , col = "red" )
lines( c(1:366),Pollution_Daily.test[,2])
summary(lm_all)$coefficients[,4]
summary(lm_all)[8]

```
After fitting a full model we see every single predictor besides year is significant however R square is only 0.4 which suggests even though each coefficient is directionally correct the variation of response is not accurate

We can see some diagnostics as to why our model may not be that effective
```{r}
#partialregress


r.ydew=update(lm_all , ~. - Avg_Day_DEWP)$res
nonatrain <- na.omit(trainingdate)
r.dew=lm(Avg_Day_DEWP ~ . , data = nonatrain[ , - 1 ])$res
tmp=lm(r.ydew ~ r.dew )

tmp
r.ytemp=update(lm_all , ~. -Avg_Day_TEMP)$res
r.temp=lm(Avg_Day_TEMP ~ . , data = nonatrain [ , -1 ])$res
tmptemp=lm(r.ytemp~r.temp)
r.ypres=update(lm_all ,~. - Avg_Day_PRES)$res
r.pres=lm(Avg_Day_PRES ~. , data=nonatrain[,-1])$res
tmppres=lm(r.ypres~r.pres)
r.ylws=update(lm_all,~. -Max_Day_WLS)$res
r.lws=lm(Max_Day_LWS ~.,data=nonatrain[,-1])$res
tmplws=lm(r.ylws~r.lws)
r.yls <- update(lm_all,~. -Max_Day_LS)$res
r.ls <- lm( Max_Day_LS ~. , data= nonatrain [ ,-1 ])$res
tmpls <- lm(r.yls~r.ls)
r.ylr <- update(lm_all ,~. - Max_Day_LR)$res
r.lr <- lm(Max_Day_LR ~.,data = nonatrain[ , -1 ] )$res
tmplr <- lm(r.ylr ~ r.lr )
r.yyear = update (lm_all,~.-Year)$res
r.year=lm(Year~.,data=nonatrain[ , -1 ] )$res
tmpyear=lm(r.yyear~r.year)
r.ymonth = update (lm_all,~.-Month)$res
r.month = lm(Month~.,data=nonatrain[,-1])$res
tmpmonth=lm(r.ymonth~r.month)
r.yday=update(lm_all,~.-Day)$res
r.day=lm(Day~.,data=nonatrain[,-1])$res
tmpday=lm(r.yday~r.day)
#5x2 to show each
titles='pollution daily res'
par(mfrow=c(2,5))
plot(r.dew,r.ydew,xlab="dew residual",ylab=titles)
abline(tmp)


plot(r.temp,r.ytemp,xlab="temp residual",ylab=titles)
abline(tmptemp)
plot(r.pres,r.ypres,xlab="pres residual",ylab= titles)
abline(tmppres)

plot(r.lws,r.ylws,xlab="lws residual",ylab=titles)
abline(tmplws)
plot(r.ls,r.yls,xlab='ls residual',ylab=titles)
abline(tmpls)
plot(r.lr,r.ylr,xlab='lr residual',ylab=titles)
abline(tmplr)
plot(r.year,r.yyear,xlab='year residual' , ylab=titles)
abline(tmpyear)

plot(r.month,r.ymonth,xlab="month residual",ylab=titles)
abline(tmpmonth)
plot(r.day,r.yday,xlab="day residual",ylab=titles)
abline(tmpday)
```
We see that there are a lot of high influence points in partial regression for each numerical variable 


```{r include=FALSE}
##Functions to make Diagnostics Easier
test_error_assumptions<-function(x){
  b=bptest(x)$p.value
  c=shapiro.test(residuals(x))$p.value
  d=dwtest(x)$p.value
  a=data.frame("Homocedasticity",b>0.05,"Normality",c>0.05,"Uncorrelated Errors",d>0.05)
  return(a)
}

test_leverage<-function(x){
n=nrow(model.matrix(x)); p=ncol(model.matrix(x));
lev=influence(x)$hat
a=lev[lev>2*p/n]
  return(a)
}
ncol(model.matrix(lm_all))
test_outlier<-function(x){
  n=nrow(model.matrix(x)); p=ncol(model.matrix(x));
  jack=rstudent(x)
  b=jack[abs(jack)>abs(qt(.05/(2*n), n-p-1))]
  c=abs(qt(.05/(2*n), n-p-1))
  d=">"
  a=data.frame(b,d,c)
  return(a)
}
test_influence<-function(x){
  cook=cooks.distance(x)
  b=cook[cook>1]
  a=data.frame(b)
  return(a)
}
```
Now we can check some of the plot of diagnostic


```{r echo=FALSE}
lm_all_2=lm(Avg_Day_PM2.5~.-Date_D,data=Pollution_Daily.train)
```

```{r echo = FALSE }
par(mfrow=c(2,2))
plot(lm_all)
```
Taking a glance at our linear model, we see that it does not appear to meet all error assumptions.  Particularly, the Q-Q plot suggests non-normality and the Fitted-Residual plot suggests heteroscedasticity and some degree of non-linearity.  However, the Residuals-Leverage plot appears to indicate that we don't have any high influence points.


```{r echo=FALSE}
##test_error_assumptions(lm_all_2)
##Testing Homocedasticity
bptest(lm_all)
##Testing Normality
shapiro.test(residuals(lm_all))
##Testing Uncorrelated Errors
dwtest(lm_all)

plot(1:1434, summary(lm_all)$res, type='o')
abline(h=0, lty=2, col="blue", lwd=2)
```
As we can tell through testing more formally, none of the error assumptions of homocedasticity, normality, and uncorrelated errors are accurate.

```{r echo=FALSE}
##test_influence(lm_all)
##test_leverage(lm_all)
par(mfrow=c(1,2))
##Plot cooks.distance
cook = cooks.distance(lm_all)
halfnorm(cook, labs=row.names(Pollution_Daily.train), ylab="Cook's distances")
##Plot Leverages
lev=influence(lm_all)$hat
halfnorm(lev, labs=row.names(Pollution_Daily.train), ylab="Leverages")
##Checking for cooks.distance greater than 1
# max(cooks.distance(lm_all_2))
##Check For High Leverage Points
# n=nrow(model.matrix(lm_all_2)); p=ncol(model.matrix(lm_all_2));
# lev[lev>2*p/n]

```
In regards to unusual observations, our maximum cooks distance as seen above indicates we have no datapoints that would be classified as highly influential, since it is much less than one.  In constrast, however, we seem to have an abundance of high-leverage points.  However, it is unclear at first glance how many of these are "good" or "bad" leverage points, although we can assume some points like observations 3 and 1468 with wildly different y-values are likely "bad."



```{r echo=FALSE}
test_outlier(lm_all)
# rstudent(lm_all_2)
```
As we can see above, we also have four outliers in the dataset.

So in order to remedy non linearity, heteroscedasticity, non normal residual and autocorrelation we would try to

```{r echo=FALSE}
##Remove Outliers-Note that with the rows we must be mindful we removed one in five values from the train data.  We must multiply our outlier residuals by 4/5 and round down to the nearest integer.
boxcox(lm_all)

```

```{r echo=FALSE}
test_outlier(lm_all)
```

```{r echo=FALSE}
boxcox(lm_all,plotit=T)
par(mfrow=c(2,2))
bc=boxcox(lm_all);
lambda=bc$x[which.max(bc$y)]
```

```{r echo=FALSE}
##Fitting BoxCox model
#lm_all_4=lm((Avg_Day_PM2.5^lambda-1)/lambda~.-Date_D,data=Pollution_Daily.train.new)
#summary(lm_all_4)

```

```{r echo=FALSE}
#g = gls(Avg_Day_PM2.5~.-Date_D, correlation = corARMA(p=1), data=na.omit(Pollution_Daily.train.new))
#summary(g)
```

**Section 4: Conclusions**

Through our analysis we have learned many things, such as:
